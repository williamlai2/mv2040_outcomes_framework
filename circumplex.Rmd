---
title: "MV2040 outcomes framework - circumplex"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
pacman::p_load(tidyverse, readxl, janitor)
```

```{r}
data_raw <- read_excel("data_in/test_data.xlsx") %>% 
  clean_names()

data <- data_raw  %>% 
  filter(level == "Primary") %>% 
  rename(year1 = baseline_data, year2 = result, target = x2040_target) %>% 
  select(theme, sd_number, category, measure, year1, year2, target, desired_direction) %>% 
  mutate(year1 = round(year1, 1), year2 = round(year2, 1), target = round(target, 1)) %>% 
  mutate(circ_val = case_when(desired_direction == "Increase" & year2 > target ~ 1, # exceeds target
                              desired_direction == "Increase" & year1 < year2 & year2 < target ~ 0.75, # has improved, but not exceeding target
                              desired_direction == "Increase" & year1 > year2 ~ 0.25, # has regressed
                              desired_direction == "Decrease" & year2 < target ~ 1, # exceeds target
                              desired_direction == "Decrease" & year1 > year2 & year2 < target ~ 0.75, # has improved, but not exceeding target
                              desired_direction == "Decrease" & year1 < year2 ~ 0.25, # has regressed
                              is.na(year2) ~ 0.5, # no second year data
                              TRUE ~ 0.25)) %>% # no baseline data
  mutate(theme = str_to_title(theme)) 

data

cat_factors <- data %>% 
  distinct(category) %>% 
  pull()


# this will need to take in to account the measures where we want a decrease (e.g. income inequality) - add a column showing the desired direction then redo the case_when !!!!!
# perhaps difference between baseline and target, then normalise progress towards
# but what if we are going backwards?
```

```{r}
data_grouped_by_cat1 <- data %>% 
  mutate(category = factor(category, levels = cat_factors)) %>% 
  mutate(theme = factor(theme, levels = c("Fair", "Thriving", "Connected", "Green", "Beautiful"))) %>% 
  group_by(theme, category) %>% 
  summarise(mean_circ = mean(circ_val)) %>% 
  mutate(mean_circ = mean_circ * 100) %>% 
  mutate(mean_circ = round(mean_circ, 1)) %>% 
  arrange(theme) 

data_grouped_split <- data_grouped_by_cat1 %>% 
  mutate(category2 = str_replace_all(category, " ", "\n"))  %>% 
  ungroup() %>% 
  select(category, category2)

data_grouped_split_pull <- data_grouped_split %>% 
  select(category2) %>% 
  pull()

#split text factors
data_grouped_by_cat <- data_grouped_by_cat1 %>% 
  left_join(data_grouped_split, by = "category") %>% 
  mutate(category2 = factor(category2, levels = data_grouped_split_pull))

```


```{r, fig.height=10, fig.width=10}
ggplot(data_grouped_by_cat, aes(category2, mean_circ, fill = theme)) + 
  geom_col(width = 1, col = "white") + ylim(0, 100) +coord_polar() +
  theme_minimal() +
  theme(plot.margin = margin(0, 0, 0, 0, "cm")) +
  scale_fill_manual(values = c("Fair" = "#E55048", "Thriving" = "#31788F", "Connected" = "#6A4479", "Green" = "#4EA546", "Beautiful" = "#E3A51E"), drop = FALSE) +
  labs(title = "Progress towards targets", x = NULL, y = "Progress score", fill = "Theme") +
  theme(legend.position = c(0.92, 0.9)) + #legend position
  theme(axis.text = element_text(face = "bold", size = 12)) + # xlab titles
  guides(fill = guide_legend(title.theme = element_text(face = "bold", size = 11))) + #legend title
  theme(legend.text = element_text(size = 10, face = "bold")) + #legend labels 
  theme(plot.title = element_text(size = 14, face = "bold")) #graph title
```


```{r}
#the data
data_selected_test <- data_raw  %>% 
  filter(level == "Primary") %>% 
  rename(year1 = baseline_data, year2 = result, target = x2040_target) %>% 
  select(theme, sd_number, category, measure, year1, year2, target, desired_direction, test_include) %>% 
  filter(test_include == 1) %>%  
  mutate(current = case_when(!is.na(year2) ~ year2,
                             TRUE ~ year1)) %>% 
  select(-year1, -year2) %>% 
  mutate(theme = str_to_title(theme)) %>% 
  mutate(target = round(target*100, 1)) %>% 
  mutate(current = round(current*100, 1)) %>% 
  mutate(measure2 = str_replace_all(measure, " ", "\n"))

#for the factors
data_selected_pull <- data_selected_test %>% 
  select(measure2) %>% 
  pull()

#change to factors
data_selected_test <- data_selected_test %>% 
  mutate(measure2 = factor(measure2, levels = data_selected_pull)) %>% 
  mutate(theme = factor(theme, levels = c("Fair", "Thriving", "Connected", "Green", "Beautiful")))

```

```{r, fig.height=10, fig.width=10}
ggplot(data_selected_test, aes(measure2, current, fill = theme)) + 
  geom_col(width = 1, col = "white", alpha = 0.5) + ylim(0, 100) + coord_polar() + #current
  geom_col(aes(measure2, target), alpha = 0.5, width = 1, col = "white") + ylim(0, 100) + coord_polar() + # target
  theme_minimal() +
  theme(plot.margin = margin(0, 0, 0, 0, "cm")) +
  scale_fill_manual(values = c("Fair" = "#E55048", "Thriving" = "#31788F", "Connected" = "#6A4479", "Green" = "#4EA546", "Beautiful" = "#E3A51E"), drop = FALSE) +
  labs(title = "Progress towards targets", subtitle = "Selected measures only", x = NULL, y = "Percentage", fill = "Theme", caption = "The darker shading indicates the current state, the lighter shading indicates the target for 2040.") +
  theme(legend.position = c(0.92, 0.9)) + #legend position
  theme(axis.text = element_text(face = "bold", size = 10)) + # xlab titles
  guides(fill = guide_legend(title.theme = element_text(face = "bold", size = 11))) + #legend title
  theme(legend.text = element_text(size = 10, face = "bold")) + #legend labels 
  theme(plot.title = element_text(size = 14, face = "bold")) #graph title
```

```{r, fig.height=10, fig.width=10}
ggplot(data_selected_test %>%  filter(theme == "Fair"), aes(measure2, current, fill = theme)) + 
  geom_col(width = 1, col = "white", alpha = 0.5) + ylim(0, 100) + coord_polar() + #current
  geom_col(aes(measure2, target), alpha = 0.5, width = 1, col = "white") + ylim(0, 100) + coord_polar() + # target
  theme_minimal() +
  theme(plot.margin = margin(0, 0, 0, 0, "cm")) +
  scale_fill_manual(values = c("Fair" = "#E55048", "Thriving" = "#31788F", "Connected" = "#6A4479", "Green" = "#4EA546", "Beautiful" = "#E3A51E"), drop = FALSE) +
  labs(title = "Progress towards targets", subtitle = "Selected measures only", x = NULL, y = "Percentage", fill = "Theme") +
  theme(legend.position = c(0.92, 0.9)) + #legend position
  theme(axis.text = element_text(face = "bold", size = 8)) + # xlab titles
  guides(fill = guide_legend(title.theme = element_text(face = "bold", size = 11))) + #legend title
  theme(legend.text = element_text(size = 10, face = "bold")) + #legend labels 
  theme(plot.title = element_text(size = 14, face = "bold")) #graph title
```

```{r, fig.height=10, fig.width=10}
ggplot(data_selected_test %>%  filter(theme == "Thriving"), aes(measure2, current, fill = theme)) + 
  geom_col(width = 1, col = "white", alpha = 0.5) + ylim(0, 100) + coord_polar() + #current
  geom_col(aes(measure2, target), alpha = 0.5, width = 1, col = "white") + ylim(0, 100) + coord_polar() + # target
  theme_minimal() +
  theme(plot.margin = margin(0, 0, 0, 0, "cm")) +
  scale_fill_manual(values = c("Fair" = "#E55048", "Thriving" = "#31788F", "Connected" = "#6A4479", "Green" = "#4EA546", "Beautiful" = "#E3A51E"), drop = FALSE) +
  labs(title = "Progress towards targets", subtitle = "Selected measures only", x = NULL, y = "Percentage", fill = "Theme") +
  theme(legend.position = c(0.92, 0.9)) + #legend position
  theme(axis.text = element_text(face = "bold", size = 8)) + # xlab titles
  guides(fill = guide_legend(title.theme = element_text(face = "bold", size = 11))) + #legend title
  theme(legend.text = element_text(size = 10, face = "bold")) + #legend labels 
  theme(plot.title = element_text(size = 14, face = "bold")) #graph title
```

```{r, fig.height=10, fig.width=10}
ggplot(data_selected_test %>%  filter(theme == "Connected"), aes(measure2, current, fill = theme)) + 
  geom_col(width = 1, col = "white", alpha = 0.5) + ylim(0, 100) + coord_polar() + #current
  geom_col(aes(measure2, target), alpha = 0.5, width = 1, col = "white") + ylim(0, 100) + coord_polar() + # target
  theme_minimal() +
  theme(plot.margin = margin(0, 0, 0, 0, "cm")) +
  scale_fill_manual(values = c("Fair" = "#E55048", "Thriving" = "#31788F", "Connected" = "#6A4479", "Green" = "#4EA546", "Beautiful" = "#E3A51E"), drop = FALSE) +
  labs(title = "Progress towards targets", subtitle = "Selected measures only", x = NULL, y = "Percentage", fill = "Theme") +
  theme(legend.position = c(0.92, 0.9)) + #legend position
  theme(axis.text = element_text(face = "bold", size = 8)) + # xlab titles
  guides(fill = guide_legend(title.theme = element_text(face = "bold", size = 11))) + #legend title
  theme(legend.text = element_text(size = 10, face = "bold")) + #legend labels 
  theme(plot.title = element_text(size = 14, face = "bold")) #graph title
```

```{r, fig.height=10, fig.width=10}
ggplot(data_selected_test %>%  filter(theme == "Green"), aes(measure2, current, fill = theme)) + 
  geom_col(width = 1, col = "white", alpha = 0.5) + ylim(0, 100) + coord_polar() + #current
  geom_col(aes(measure2, target), alpha = 0.5, width = 1, col = "white") + ylim(0, 100) + coord_polar() + # target
  theme_minimal() +
  theme(plot.margin = margin(0, 0, 0, 0, "cm")) +
  scale_fill_manual(values = c("Fair" = "#E55048", "Thriving" = "#31788F", "Connected" = "#6A4479", "Green" = "#4EA546", "Beautiful" = "#E3A51E"), drop = FALSE) +
  labs(title = "Progress towards targets", subtitle = "Selected measures only", x = NULL, y = "Percentage", fill = "Theme") +
  theme(legend.position = c(0.92, 0.9)) + #legend position
  theme(axis.text = element_text(face = "bold", size = 8)) + # xlab titles
  guides(fill = guide_legend(title.theme = element_text(face = "bold", size = 11))) + #legend title
  theme(legend.text = element_text(size = 10, face = "bold")) + #legend labels 
  theme(plot.title = element_text(size = 14, face = "bold")) #graph title
```

```{r, fig.height=10, fig.width=10}
ggplot(data_selected_test %>%  filter(theme == "Beautiful"), aes(measure2, current, fill = theme)) + 
  geom_col(width = 1, col = "white", alpha = 0.5) + ylim(0, 100) + coord_polar() + #current
  geom_col(aes(measure2, target), alpha = 0.5, width = 1, col = "white") + ylim(0, 100) + coord_polar() + # target
  theme_minimal() +
  theme(plot.margin = margin(0, 0, 0, 0, "cm")) +
  scale_fill_manual(values = c("Fair" = "#E55048", "Thriving" = "#31788F", "Connected" = "#6A4479", "Green" = "#4EA546", "Beautiful" = "#E3A51E"), drop = FALSE) +
  labs(title = "Progress towards targets", subtitle = "Selected measures only", x = NULL, y = "Percentage", fill = "Theme") +
  theme(legend.position = c(0.92, 0.9)) + #legend position
  theme(axis.text = element_text(face = "bold", size = 8)) + # xlab titles
  guides(fill = guide_legend(title.theme = element_text(face = "bold", size = 11))) + #legend title
  theme(legend.text = element_text(size = 10, face = "bold")) + #legend labels 
  theme(plot.title = element_text(size = 14, face = "bold")) #graph title
```
